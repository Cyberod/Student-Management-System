{% extends 'base.html' %}
{% block title %}Student Profile{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-4">
            <!-- Profile Card -->
            <div class="card card-success card-outline">
                <div class="card-body box-profile">
                    <div class="text-center">
                        <img class="profile-user-img img-fluid img-circle" 
                             src="{% load static %}{% static 'avatar-student.png' %}" 
                             alt="Student Profile Picture"
                             id="profileImage">
                    </div>
                    <h3 class="profile-username text-center" id="profileName">{{ user.get_full_name|default:user.username }}</h3>
                    <p class="text-muted text-center">
                        <i class="fas fa-user-graduate text-success"></i> Student
                    </p>
                    
                    <ul class="list-group list-group-unbordered mb-3">
                        <li class="list-group-item">
                            <b>Student ID</b> <span class="float-right">{{ user.username }}</span>
                        </li>
                        <li class="list-group-item">
                            <b>Email</b> <span class="float-right">{{ user.email }}</span>
                        </li>
                        {% if user.student_profile %}
                        <li class="list-group-item">
                            <b>Course</b> <span class="float-right">{{ user.student_profile.course.name|default:"Not assigned" }}</span>
                        </li>
                        <li class="list-group-item">
                            <b>Session</b> <span class="float-right">{{ user.student_profile.session_year.start_year }}-{{ user.student_profile.session_year.end_year }}</span>
                        </li>
                        <li class="list-group-item">
                            <b>Phone</b> <span class="float-right">{{ user.student_profile.phone_number|default:"Not set" }}</span>
                        </li>
                        {% endif %}
                    </ul>
                    
                    <button class="btn btn-success btn-block" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>
            </div>

            <!-- Academic Stats Card -->
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-line"></i> Academic Statistics
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 text-center">
                            <div class="border-right">
                                <h4 class="text-primary" id="totalSubjects">0</h4>
                                <small>Total Subjects</small>
                            </div>
                        </div>
                        <div class="col-6 text-center">
                            <h4 class="text-success" id="averageGrade">0%</h4>
                            <small>Average Grade</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-4 text-center">
                            <h5 class="text-info" id="totalClasses">0</h5>
                            <small>Classes</small>
                        </div>
                        <div class="col-4 text-center">
                            <h5 class="text-warning" id="attendanceRate">0%</h5>
                            <small>Attendance</small>
                        </div>
                        <div class="col-4 text-center">
                            <h5 class="text-danger" id="totalLecturers">0</h5>
                            <small>Lecturers</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h3>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'student_progress' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-chart-line"></i> View Progress
                        </a>
                        <a href="{% url 'student_results' %}" class="btn btn-success btn-sm">
                            <i class="fas fa-trophy"></i> My Results
                        </a>
                        <a href="{% url 'student_lecturers' %}" class="btn btn-info btn-sm">
                            <i class="fas fa-chalkboard-teacher"></i> My Lecturers
                        </a>
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
            </div>

            <!-- Performance Overview -->
            <div class="card card-info">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-star"></i> Performance Overview
                    </h3>
                </div>
                <div class="card-body">
                    <div class="progress-group">
                        <span class="float-right"><b id="attendanceProgress">0</b>/100</span>
                        <span>Attendance Rate</span>
                        <div class="progress progress-sm">
                            <div class="progress-bar bg-success" id="attendanceProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-group">
                        <span class="float-right"><b id="gradeProgress">0</b>/100</span>
                        <span>Average Grade</span>
                        <div class="progress progress-sm">
                            <div class="progress-bar bg-primary" id="gradeProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <!-- Profile Information -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-user"></i> Personal Information
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>First Name</label>
                                <p class="form-control-static">{{ user.first_name|default:"Not set" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Last Name</label>
                                <p class="form-control-static">{{ user.last_name|default:"Not set" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Email Address</label>
                                <p class="form-control-static">{{ user.email }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Student ID</label>
                                <p class="form-control-static">{{ user.username }}</p>
                            </div>
                        </div>
                        {% if user.student_profile %}
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Phone Number</label>
                                <p class="form-control-static">{{ user.student_profile.phone_number|default:"Not set" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Gender</label>
                                <p class="form-control-static">{{ user.student_profile.gender|default:"Not set" }}</p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <label>Address</label>
                                <p class="form-control-static">{{ user.student_profile.address|default:"Not set" }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Academic Information -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-graduation-cap"></i> Academic Information
                    </h3>
                </div>
                <div class="card-body">
                    {% if user.student_profile %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Course</label>
                                <p class="form-control-static">
                                    <span class="badge bg-primary">{{ user.student_profile.course.name|default:"Not assigned" }}</span>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Session Year</label>
                                <p class="form-control-static">
                                    <span class="badge bg-info">{{ user.student_profile.session_year.start_year }}-{{ user.student_profile.session_year.end_year }}</span>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Enrollment Date</label>
                                <p class="form-control-static">{{ user.date_joined|date:"M d, Y" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Academic Status</label>
                                <p class="form-control-static">
                                    <span class="badge bg-success">Active</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Student profile not found. Please contact administration.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Subject Performance -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-book"></i> Subject Performance
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="subjectPerformanceTable">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Lecturer</th>
                                    <th>Attendance</th>
                                    <th>Test Score</th>
                                    <th>Exam Score</th>
                                    <th>Total</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Subject performance will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-history"></i> Recent Activities
                    </h3>
                </div>
                <div class="card-body">
                    <div class="timeline" id="recentActivities">
                        <!-- Activities will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Attendance Chart -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-area"></i> Attendance Trend
                    </h3>
                </div>
                <div class="card-body">
                    <canvas id="attendanceChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProfileForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" name="first_name" value="{{ user.first_name }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" name="last_name" value="{{ user.last_name }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editEmail" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="editEmail" name="email" value="{{ user.email }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editPhone" class="form-label">Phone Number</label>
                            <input type="text" class="form-control" id="editPhone" name="phone_number" value="{{ user.student_profile.phone_number|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editGender" class="form-label">Gender</label>
                            <select class="form-control" id="editGender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="Male" {% if user.student_profile.gender == 'Male' %}selected{% endif %}>Male</option>
                                <option value="Female" {% if user.student_profile.gender == 'Female' %}selected{% endif %}>Female</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="editAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="editAddress" name="address" rows="3">{{ user.student_profile.address|default:'' }}</textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" name="new_password" required minlength="8">
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading profile data...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    let attendanceChart = null;

    // CSRF setup
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    // Load student statistics
    function loadStudentStats() {
        $('#loadingModal').modal('show');
        
        $.get('/api/student/profile/stats/')
            .done(function(data) {
                $('#totalSubjects').text(data.total_subjects);
                $('#averageGrade').text(data.average_grade + '%');
                $('#totalClasses').text(data.total_classes);
                $('#attendanceRate').text(data.attendance_rate + '%');
                $('#totalLecturers').text(data.total_lecturers);
                
                // Update progress bars
                $('#attendanceProgress').text(data.attendance_rate);
                $('#attendanceProgressBar').css('width', data.attendance_rate + '%');
                $('#gradeProgress').text(data.average_grade);
                $('#gradeProgressBar').css('width', data.average_grade + '%');
                
                loadSubjectPerformance(data.subject_performance);
                loadAttendanceChart(data.attendance_trend);
                $('#loadingModal').modal('hide');
            })
            .fail(function(xhr) {
                $('#loadingModal').modal('hide');
                console.error('Failed to load student stats:', xhr.responseText);
                showDefaultData();
            });
    }

    // Show default data when API fails
    function showDefaultData() {
        $('#subjectPerformanceTable tbody').html(`
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-info-circle"></i> No performance data available yet
                </td>
            </tr>
        `);
    }

    // Load subject performance table
    function loadSubjectPerformance(subjects) {
        let tableRows = '';
        
        if (subjects && subjects.length > 0) {
            subjects.forEach(subject => {
                const total = subject.test_score + subject.exam_score;
                const grade = getGrade(total);
                const gradeClass = getGradeClass(grade);
                const attendanceClass = subject.attendance >= 75 ? 'success' : 
                                       subject.attendance >= 50 ? 'warning' : 'danger';
                
                tableRows += `
                    <tr>
                        <td><strong>${subject.name}</strong></td>
                        <td>${subject.lecturer}</td>
                        <td>
                            <span class="badge bg-${attendanceClass}">${subject.attendance}%</span>
                        </td>
                        <td>
                            <span class="badge bg-info">${subject.test_score}</span>
                        </td>
                        <td>
                            <span class="badge bg-primary">${subject.exam_score}</span>
                        </td>
                        <td>
                            <strong>${total}</strong>
                        </td>
                        <td>
                            <span class="badge bg-${gradeClass}">${grade}</span>
                        </td>
                    </tr>
                `;
            });
        } else {
            tableRows = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="fas fa-info-circle"></i> No subject performance data available
                    </td>
                </tr>
            `;
        }
        
        $('#subjectPerformanceTable tbody').html(tableRows);
    }

    // Get grade based on total score
    function getGrade(total) {
        if (total >= 80) return 'A';
        if (total >= 70) return 'B';
        if (total >= 60) return 'C';
        if (total >= 50) return 'D';
        return 'F';
    }

    // Get grade CSS class
    function getGradeClass(grade) {
        switch(grade) {
            case 'A': return 'success';
            case 'B': return 'info';
            case 'C': return 'warning';
            case 'D': return 'secondary';
            case 'F': return 'danger';
            default: return 'secondary';
        }
    }

    // Load attendance chart
    function loadAttendanceChart(attendanceData) {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        
        // Destroy existing chart
        if (attendanceChart) {
            attendanceChart.destroy();
        }
        
        if (attendanceData && attendanceData.length > 0) {
            const labels = attendanceData.map(item => item.date);
            const data = attendanceData.map(item => item.percentage);
            
            attendanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Attendance %',
                        data: data,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Attendance: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // Show no data message
            ctx.font = '16px Arial';
            ctx.fillStyle = '#999';
            ctx.textAlign = 'center';
            ctx.fillText('No attendance data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
    }

    // Load recent activities
    function loadRecentActivities() {
        $.get('/api/student/profile/activities/')
            .done(function(data) {
                let activitiesHtml = '';
                
                if (data.activities && data.activities.length > 0) {
                    data.activities.forEach(activity => {
                        const iconClass = activity.type === 'attendance' ? 'calendar-check' :
                                         activity.type === 'result' ? 'trophy' : 
                                         activity.type === 'enrollment' ? 'user-plus' : 'bell';
                        const colorClass = activity.type === 'attendance' ? 'success' :
                                          activity.type === 'result' ? 'warning' : 
                                          activity.type === 'enrollment' ? 'info' : 'primary';
                        
                        activitiesHtml += `
                            <div class="timeline-item">
                                <span class="time">
                                    <i class="fas fa-clock"></i> ${activity.time_ago}
                                </span>
                                <h3 class="timeline-header">
                                    <i class="fas fa-${iconClass} text-${colorClass}"></i>
                                    ${activity.title}
                                </h3>
                                <div class="timeline-body">
                                    ${activity.description}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    activitiesHtml = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            No recent activities found. Your academic activities will appear here.
                        </div>
                    `;
                }
                
                $('#recentActivities').html(activitiesHtml);
            })
            .fail(function() {
                $('#recentActivities').html(`
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Unable to load recent activities.
                    </div>
                `);
            });
    }

    // Edit profile form submission
    $('#editProfileForm').submit(function(e) {
        e.preventDefault();
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
        
        $.ajax({
            url: '/api/student/profile/update/',
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            data: JSON.stringify({
                first_name: $('#editFirstName').val(),
                last_name: $('#editLastName').val(),
                email: $('#editEmail').val(),
                phone_number: $('#editPhone').val(),
                gender: $('#editGender').val(),
                address: $('#editAddress').val()
            }),
            success: function(response) {
                $('#editProfileModal').modal('hide');
                $('#profileName').text(response.full_name);
                alert('Profile updated successfully!');
                location.reload();
            },
            error: function(xhr) {
                console.error('Profile update failed:', xhr.responseText);
                const errorMsg = xhr.responseJSON?.error || 'Failed to update profile';
                alert('Error: ' + errorMsg);
            },
            complete: function() {
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Change password form submission
    $('#changePasswordForm').submit(function(e) {
        e.preventDefault();
        
        const newPassword = $('#newPassword').val();
        const confirmPassword = $('#confirmPassword').val();
        
        if (newPassword !== confirmPassword) {
            alert('New passwords do not match!');
            return;
        }
        
        if (newPassword.length < 8) {
            alert('Password must be at least 8 characters long!');
            return;
        }
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Changing...');
        
        $.ajax({
            url: '/api/profile/change-password/',
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            data: JSON.stringify({
                current_password: $('#currentPassword').val(),
                new_password: newPassword
            }),
            success: function(response) {
                $('#changePasswordModal').modal('hide');
                $('#changePasswordForm')[0].reset();
                alert('Password changed successfully!');
            },
            error: function(xhr) {
                console.error('Password change failed:', xhr.responseText);
                const errorMsg = xhr.responseJSON?.error || 'Failed to change password';
                alert('Error: ' + errorMsg);
            },
            complete: function() {
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Password strength indicator
    $('#newPassword').on('input', function() {
        const password = $(this).val();
        let strength = 0;
        let feedback = '';
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        switch(strength) {
            case 0:
            case 1:
                feedback = '<small class="text-danger">Weak password</small>';
                break;
            case 2:
            case 3:
                feedback = '<small class="text-warning">Medium password</small>';
                break;
            case 4:
            case 5:
                feedback = '<small class="text-success">Strong password</small>';
                break;
        }
        
        $(this).siblings('.password-feedback').remove();
        $(this).after(`<div class="password-feedback">${feedback}</div>`);
    });

    // Confirm password validation
    $('#confirmPassword').on('input', function() {
        const password = $('#newPassword').val();
        const confirmPassword = $(this).val();
        
        $(this).siblings('.confirm-feedback').remove();
        
        if (confirmPassword && password !== confirmPassword) {
            $(this).after('<div class="confirm-feedback"><small class="text-danger">Passwords do not match</small></div>');
            $(this).addClass('is-invalid');
        } else if (confirmPassword && password === confirmPassword) {
            $(this).after('<div class="confirm-feedback"><small class="text-success">Passwords match</small></div>');
            $(this).removeClass('is-invalid').addClass('is-valid');
        }
    });

    // Performance analysis
    function analyzePerformance() {
        const attendanceRate = parseInt($('#attendanceRate').text());
        const averageGrade = parseInt($('#averageGrade').text());
        
        let performanceMessage = '';
        let performanceClass = '';
        
        if (attendanceRate >= 75 && averageGrade >= 70) {
            performanceMessage = 'Excellent performance! Keep up the good work.';
            performanceClass = 'success';
        } else if (attendanceRate >= 60 && averageGrade >= 60) {
            performanceMessage = 'Good performance. There\'s room for improvement.';
            performanceClass = 'info';
        } else if (attendanceRate >= 50 || averageGrade >= 50) {
            performanceMessage = 'Average performance. Consider improving attendance and study habits.';
            performanceClass = 'warning';
        } else {
            performanceMessage = 'Performance needs attention. Please consult with your lecturers.';
            performanceClass = 'danger';
        }
        
        // Add performance alert if not exists
        if ($('#performanceAlert').length === 0) {
            $('.card-body').first().prepend(`
                <div id="performanceAlert" class="alert alert-${performanceClass} alert-dismissible fade show">
                    <i class="fas fa-chart-line"></i>
                    <strong>Performance Analysis:</strong> ${performanceMessage}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
        }
    }

    // Auto-refresh stats every 10 minutes
    setInterval(function() {
        loadStudentStats();
    }, 600000);

    // Keyboard shortcuts
    $(document).keydown(function(e) {
        // Ctrl + E to edit profile
        if (e.ctrlKey && e.which === 69) {
            e.preventDefault();
            $('#editProfileModal').modal('show');
        }
        
        // Ctrl + P to change password
        if (e.ctrlKey && e.which === 80) {
            e.preventDefault();
            $('#changePasswordModal').modal('show');
        }
        
        // Ctrl + R to refresh stats
        if (e.ctrlKey && e.which === 82) {
            e.preventDefault();
            loadStudentStats();
        }
    });

    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Add helpful tooltips
    $('#attendanceProgressBar').attr('title', 'Your current attendance rate');
    $('#gradeProgressBar').attr('title', 'Your current average grade');
    $('.badge').each(function() {
        const text = $(this).text();
        if (text.includes('%')) {
            $(this).attr('title', 'Click to view details');
        }
    });

    // Modal event handlers
    $('#editProfileModal').on('shown.bs.modal', function() {
        $('#editFirstName').focus();
    });

    $('#changePasswordModal').on('shown.bs.modal', function() {
        $('#currentPassword').focus();
    });

    $('#editProfileModal').on('hidden.bs.modal', function() {
        $('#editProfileForm')[0].reset();
        $('.password-feedback, .confirm-feedback').remove();
        $('.is-invalid, .is-valid').removeClass('is-invalid is-valid');
    });

    $('#changePasswordModal').on('hidden.bs.modal', function() {
        $('#changePasswordForm')[0].reset();
        $('.password-feedback, .confirm-feedback').remove();
        $('.is-invalid, .is-valid').removeClass('is-invalid is-valid');
    });

    // Print profile functionality
    function printProfile() {
        const printWindow = window.open('', '_blank');
        const profileHtml = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Student Profile - {{ user.get_full_name|default:user.username }}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        .no-print { display: none !important; }
                        .page-break { page-break-before: always; }
                    }
                    body { font-size: 12px; }
                    .profile-header { text-align: center; margin-bottom: 30px; }
                    .info-section { margin-bottom: 20px; }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="profile-header">
                        <h2>Student Profile</h2>
                        <h4>{{ user.get_full_name|default:user.username }}</h4>
                        <p>Student ID: {{ user.username }}</p>
                    </div>
                    
                    <div class="info-section">
                        <h5>Personal Information</h5>
                        <div class="row">
                            <div class="col-6">Email: {{ user.email }}</div>
                            <div class="col-6">Phone: {{ user.student_profile.phone_number|default:"Not set" }}</div>
                            <div class="col-6">Gender: {{ user.student_profile.gender|default:"Not set" }}</div>
                            <div class="col-6">Course: {{ user.student_profile.course.name|default:"Not assigned" }}</div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h5>Academic Statistics</h5>
                        <div class="row">
                            <div class="col-3">Total Subjects: <span id="printTotalSubjects">0</span></div>
                            <div class="col-3">Average Grade: <span id="printAverageGrade">0%</span></div>
                            <div class="col-3">Attendance Rate: <span id="printAttendanceRate">0%</span></div>
                            <div class="col-3">Total Classes: <span id="printTotalClasses">0</span></div>
                        </div>
                    </div>
                    
                    <div class="info-section page-break">
                        <h5>Subject Performance</h5>
                        ${$('#subjectPerformanceTable')[0].outerHTML}
                    </div>
                </div>
            </body>
            </html>
        `;
        
        printWindow.document.write(profileHtml);
        printWindow.document.close();
        
        // Update print values
        setTimeout(() => {
            printWindow.document.getElementById('printTotalSubjects').textContent = $('#totalSubjects').text();
            printWindow.document.getElementById('printAverageGrade').textContent = $('#averageGrade').text();
            printWindow.document.getElementById('printAttendanceRate').textContent = $('#attendanceRate').text();
            printWindow.document.getElementById('printTotalClasses').textContent = $('#totalClasses').text();
            
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }, 1000);
    }

    // Add print button to quick actions
    $('.card-warning .card-body .d-grid').append(`
        <button class="btn btn-secondary btn-sm" onclick="printProfile()">
            <i class="fas fa-print"></i> Print Profile
        </button>
    `);

    // Export profile data as JSON
    function exportProfileData() {
        const profileData = {
            personal_info: {
                name: $('#profileName').text(),
                email: '{{ user.email }}',
                student_id: '{{ user.username }}',
                course: '{{ user.student_profile.course.name|default:"Not assigned" }}',
                session: '{{ user.student_profile.session_year.start_year }}-{{ user.student_profile.session_year.end_year }}'
            },
            academic_stats: {
                total_subjects: $('#totalSubjects').text(),
                average_grade: $('#averageGrade').text(),
                attendance_rate: $('#attendanceRate').text(),
                total_classes: $('#totalClasses').text()
            },
            timestamp: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(profileData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `student_profile_${new Date().getTime()}.json`;
        link.click();
        URL.revokeObjectURL(url);
    }

    // Add export button
    $('.card-warning .card-body .d-grid').append(`
        <button class="btn btn-outline-secondary btn-sm" onclick="exportProfileData()">
            <i class="fas fa-download"></i> Export Data
        </button>
    `);

    // Responsive chart resize
    $(window).resize(function() {
        if (attendanceChart) {
            attendanceChart.resize();
        }
    });

    // Cleanup on page unload
    $(window).on('beforeunload', function() {
        if (attendanceChart) {
            attendanceChart.destroy();
        }
    });

    // Initialize everything
    loadStudentStats();
    loadRecentActivities();
    
    // Analyze performance after stats are loaded
    setTimeout(analyzePerformance, 2000);
    
    console.log('Student profile initialized successfully');
    
    // Make functions globally available
    window.printProfile = printProfile;
    window.exportProfileData = exportProfileData;
});
</script>
{% endblock %}


