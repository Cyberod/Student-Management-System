{% extends 'base.html' %}

{% block title %}My Results{% endblock %}
{% block page_title %}Academic Results{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
<li class="breadcrumb-item active">My Results</li>
{% endblock %}

{% block content %}
<!-- Results Summary Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h3 id="currentGPA">3.2</h3>
                <p class="mb-0">Current GPA</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-trophy fa-2x mb-2"></i>
                <h3 id="highestGrade">A</h3>
                <p class="mb-0">Highest Grade</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-percentage fa-2x mb-2"></i>
                <h3 id="averageScore">78.5%</h3>
                <p class="mb-0">Average Score</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-book fa-2x mb-2"></i>
                <h3 id="completedSubjects">{{ subjects.count }}</h3>
                <p class="mb-0">Subjects</p>
            </div>
        </div>
    </div>
</div>

<!-- Filter and Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="semesterFilter" class="form-label">Filter by Semester</label>
                        <select class="form-control" id="semesterFilter">
                            <option value="all">All Semesters</option>
                            <option value="current">Current Semester</option>
                            <option value="previous">Previous Semester</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="subjectFilter" class="form-label">Filter by Subject</label>
                        <select class="form-control" id="subjectFilter">
                            <option value="all">All Subjects</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="gradeFilter" class="form-label">Filter by Grade</label>
                        <select class="form-control" id="gradeFilter">
                            <option value="all">All Grades</option>
                            <option value="A">A Grades</option>
                            <option value="B">B Grades</option>
                            <option value="C">C Grades</option>
                            <option value="D">D Grades</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table text-primary mr-2"></i>
                    Detailed Results
                </h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="exportResults('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="exportResults('excel')">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="printResults()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="resultsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Subject</th>
                                <th>Assessment Type</th>
                                <th>Date</th>
                                <th>Max Score</th>
                                <th>Your Score</th>
                                <th>Percentage</th>
                                <th>Grade</th>
                                <th>Remarks</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subject in subjects %}
                            <!-- Sample data - replace with actual results -->
                            <tr data-subject="{{ subject.id }}" data-grade="A" data-semester="current">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-book text-primary mr-2"></i>
                                        <div>
                                            <strong>{{ subject.name }}</strong><br>
                                            <small class="text-muted">{{ subject.course.name }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-info">Mid-term</span></td>
                                <td>2024-01-15</td>
                                <td>100</td>
                                <td>85</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" style="width: 85%">85%</div>
                                    </div>
                                </td>
                                <td><span class="badge bg-success">A</span></td>
                                <td>Excellent performance</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewResultDetails(1)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            
                            <tr data-subject="{{ subject.id }}" data-grade="B" data-semester="current">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-book text-primary mr-2"></i>
                                        <div>
                                            <strong>{{ subject.name }}</strong><br>
                                            <small class="text-muted">{{ subject.course.name }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-warning">Assignment</span></td>
                                <td>2024-01-10</td>
                                <td>50</td>
                                <td>38</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-info" style="width: 76%">76%</div>
                                    </div>
                                </td>
                                <td><span class="badge bg-info">B+</span></td>
                                <td>Good work</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewResultDetails(2)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            
                            <tr data-subject="{{ subject.id }}" data-grade="C" data-semester="previous">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-book text-primary mr-2"></i>
                                        <div>
                                            <strong>{{ subject.name }}</strong><br>
                                            <small class="text-muted">{{ subject.course.name }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-danger">Final Exam</span></td>
                                <td>2023-12-20</td>
                                <td>100</td>
                                <td>68</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-warning" style="width: 68%">68%</div>
                                    </div>
                                </td>
                                <td><span class="badge bg-warning">C+</span></td>
                                <td>Needs improvement</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewResultDetails(3)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Analytics -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-success mr-2"></i>
                    Performance Trend Analysis
                </h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie text-info mr-2"></i>
                    Grade Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="gradeChart" height="300"></canvas>
                
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>A Grades</span>
                        <span class="badge bg-success">25%</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>B Grades</span>
                        <span class="badge bg-info">45%</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>C Grades</span>
                        <span class="badge bg-warning">25%</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>D Grades</span>
                        <span class="badge bg-danger">5%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Subject-wise Performance -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-books text-warning mr-2"></i>
                    Subject-wise Performance Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for subject in subjects %}
                    <div class="col-lg-6 mb-3">
                        <div class="card border-left-primary">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <h6 class="mb-1">{{ subject.name }}</h6>
                                        <small class="text-muted">{{ subject.staff.get_full_name }}</small>
                                        
                                        <div class="mt-2">
                                            <div class="d-flex justify-content-between mb-1">
                                                <small>Overall Performance</small>
                                                <small class="text-success">78.5%</small>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-success" style="width: 78.5%"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-2">
                                            <span class="badge bg-success me-1">Current: B+</span>
                                            <span class="badge bg-info">Trend: â†—</span>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="circular-progress" data-percentage="78.5">
                                            <svg width="60" height="60">
                                                <circle cx="30" cy="30" r="25" stroke="#e9ecef" stroke-width="4" fill="none"/>
                                                <circle cx="30" cy="30" r="25" stroke="#28a745" stroke-width="4" fill="none" 
                                                        stroke-dasharray="157" stroke-dashoffset="34" stroke-linecap="round"/>
                                            </svg>
                                            <div class="percentage">78%</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted">Tests</small>
                                            <div class="fw-bold">82%</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Assignments</small>
                                            <div class="fw-bold">75%</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Exams</small>
                                            <div class="fw-bold">78%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Improvement Recommendations -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb text-warning mr-2"></i>
                    Improvement Recommendations
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-line mr-2"></i>Strengths</h6>
                            <ul class="mb-0">
                                <li>Consistent performance in Mathematics</li>
                                <li>Excellent assignment submission rate</li>
                                <li>Strong analytical skills</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle mr-2"></i>Areas to Improve</h6>
                            <ul class="mb-0">
                                <li>Physics practical scores need attention</li>
                                <li>Essay writing in English Literature</li>
                                <li>Time management in exams</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-target mr-2"></i>Action Plan</h6>
                            <ul class="mb-0">
                                <li>Schedule extra practice sessions</li>
                                <li>Join study groups for weak subjects</li>
                                <li>Meet with subject teachers regularly</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Result Details Modal -->
<div class="modal fade" id="resultDetailsModal" tabindex="-1" aria-labelledby="resultDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultDetailsModalLabel">Result Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="resultDetailsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printResultDetail()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
.border-left-primary {
    border-left: 4px solid #007bff !important;
}

.circular-progress {
    position: relative;
    display: inline-block;
}

.circular-progress .percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: bold;
    color: #28a745;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.progress {
    height: 8px;
}

.table th {
    border-top: none;
    font-weight: 600;
}

.badge {
    font-size: 0.75em;
}

.alert {
    border: none;
    border-radius: 10px;
}

.alert h6 {
    margin-bottom: 10px;
    font-weight: 600;
}

.alert ul {
    padding-left: 20px;
}

.alert ul li {
    margin-bottom: 5px;
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    initializeCharts();
    initializeDataTable();
    loadResultsData();
});

function initializeCharts() {
    // Performance Trend Chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
            datasets: [{
                label: 'Average Score',
                data: [72, 75, 78, 76, 80, 78, 82, 79],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Class Average',
                data: [70, 72, 74, 73, 76, 75, 77, 76],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: false,
                borderDash: [5, 5]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + '%';
                        }
                    }
                }
            }
        }
    });

    // Grade Distribution Chart
    const gradeCtx = document.getElementById('gradeChart').getContext('2d');
    new Chart(gradeCtx, {
        type: 'doughnut',
        data: {
            labels: ['A', 'B', 'C', 'D'],
            datasets: [{
                data: [25, 45, 25, 5],
                backgroundColor: [
                    '#28a745',
                    '#17a2b8',
                    '#ffc107',
                    '#dc3545'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                }
            }
        }
    });
}

function initializeDataTable() {
    $('#resultsTable').DataTable({
        responsive: true,
        order: [[2, 'desc']], // Sort by date descending
        pageLength: 10,
        language: {
            search: "Search results:",
            lengthMenu: "Show _MENU_ results per page",
            info: "Showing _START_ to _END_ of _TOTAL_ results",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        },
        columnDefs: [
            {
                targets: [4, 5], // Score and percentage columns
                className: 'text-center'
            },
            {
                targets: [6, 7], // Grade and remarks columns
                className: 'text-center'
            }
        ]
    });
}

function loadResultsData() {
    // CSRF setup
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    // Load actual results data from API
    $.get('/api-results/', function(data) {
        updateResultsTable(data);
        updateSummaryCards(data);
    }).fail(function(xhr) {
        console.error('Failed to load results:', xhr.responseText);
    });
}

function updateResultsTable(results) {
    const table = $('#resultsTable').DataTable();
    table.clear();

    results.forEach(result => {
        const percentage = ((result.test_score + result.exam_score) / 2).toFixed(1);
        const grade = calculateGrade(percentage);
        const gradeClass = getGradeClass(grade);
        
        table.row.add([
            `<div class="d-flex align-items-center">
                <i class="fas fa-book text-primary mr-2"></i>
                <div>
                    <strong>${result.subject_name}</strong><br>
                    <small class="text-muted">${result.subject_course || 'N/A'}</small>
                </div>
            </div>`,
            '<span class="badge bg-info">Combined</span>',
            result.created_at ? new Date(result.created_at).toLocaleDateString() : 'N/A',
            '100',
            percentage,
            `<div class="progress" style="height: 20px;">
                <div class="progress-bar ${getProgressBarClass(percentage)}" style="width: ${percentage}%">${percentage}%</div>
            </div>`,
            `<span class="badge ${gradeClass}">${grade}</span>`,
            getRemarks(percentage),
            `<button class="btn btn-sm btn-outline-primary" onclick="viewResultDetails(${result.id})">
                <i class="fas fa-eye"></i>
            </button>`
        ]);
    });

    table.draw();
}

function updateSummaryCards(results) {
    if (results.length === 0) return;

    // Calculate statistics
    const scores = results.map(r => (r.test_score + r.exam_score) / 2);
    const averageScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
    const highestScore = Math.max(...scores).toFixed(1);
    const gpa = calculateGPA(scores);

    // Update cards
    $('#currentGPA').text(gpa);
    $('#highestGrade').text(calculateGrade(highestScore));
    $('#averageScore').text(averageScore + '%');
    $('#completedSubjects').text(results.length);
}

function calculateGrade(percentage) {
    if (percentage >= 90) return 'A+';
    if (percentage >= 85) return 'A';
    if (percentage >= 80) return 'A-';
    if (percentage >= 75) return 'B+';
    if (percentage >= 70) return 'B';
    if (percentage >= 65) return 'B-';
    if (percentage >= 60) return 'C+';
    if (percentage >= 55) return 'C';
    if (percentage >= 50) return 'C-';
    return 'F';
}

function calculateGPA(scores) {
    const gradePoints = scores.map(score => {
        if (score >= 90) return 4.0;
        if (score >= 85) return 3.7;
        if (score >= 80) return 3.3;
        if (score >= 75) return 3.0;
        if (score >= 70) return 2.7;
        if (score >= 65) return 2.3;
        if (score >= 60) return 2.0;
        if (score >= 55) return 1.7;
        if (score >= 50) return 1.3;
        return 0.0;
    });
    
    const gpa = gradePoints.reduce((a, b) => a + b, 0) / gradePoints.length;
    return gpa.toFixed(2);
}

function getGradeClass(grade) {
    if (grade.startsWith('A')) return 'bg-success';
    if (grade.startsWith('B')) return 'bg-info';
    if (grade.startsWith('C')) return 'bg-warning';
    return 'bg-danger';
}

function getProgressBarClass(percentage) {
    if (percentage >= 80) return 'bg-success';
    if (percentage >= 70) return 'bg-info';
    if (percentage >= 60) return 'bg-warning';
    return 'bg-danger';
}

function getRemarks(percentage) {
    if (percentage >= 90) return 'Outstanding';
    if (percentage >= 80) return 'Excellent';
    if (percentage >= 70) return 'Good';
    if (percentage >= 60) return 'Satisfactory';
    if (percentage >= 50) return 'Needs Improvement';
    return 'Unsatisfactory';
}

function applyFilters() {
    const semesterFilter = $('#semesterFilter').val();
    const subjectFilter = $('#subjectFilter').val();
    const gradeFilter = $('#gradeFilter').val();
    
    const table = $('#resultsTable').DataTable();
    
    // Clear existing filters
    table.columns().search('').draw();
    
    // Apply filters
    let filteredRows = table.rows().nodes();
    
    $(filteredRows).show();
    
    if (semesterFilter !== 'all') {
        $(filteredRows).each(function() {
            if ($(this).data('semester') !== semesterFilter) {
                $(this).hide();
            }
        });
    }
    
    if (subjectFilter !== 'all') {
        $(filteredRows).each(function() {
            if ($(this).data('subject') != subjectFilter) {
                $(this).hide();
            }
        });
    }
    
    if (gradeFilter !== 'all') {
        $(filteredRows).each(function() {
            const grade = $(this).data('grade');
            if (!grade || !grade.startsWith(gradeFilter)) {
                $(this).hide();
            }
        });
    }
    
    table.draw();
}

function viewResultDetails(resultId) {
    // Show loading
    $('#resultDetailsContent').html(`
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading result details...</p>
        </div>
    `);
    
    $('#resultDetailsModal').modal('show');
    
    // Simulate loading result details
    setTimeout(() => {
        const detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Assessment Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Subject:</strong></td><td>Mathematics</td></tr>
                        <tr><td><strong>Assessment Type:</strong></td><td>Mid-term Examination</td></tr>
                        <tr><td><strong>Date:</strong></td><td>January 15, 2024</td></tr>
                        <tr><td><strong>Duration:</strong></td><td>2 hours</td></tr>
                        <tr><td><strong>Total Marks:</strong></td><td>100</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Performance Summary</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Your Score:</strong></td><td>85/100</td></tr>
                        <tr><td><strong>Percentage:</strong></td><td>85%</td></tr>
                        <tr><td><strong>Grade:</strong></td><td><span class="badge bg-success">A</span></td></tr>
                        <tr><td><strong>Class Average:</strong></td><td>72%</td></tr>
                        <tr><td><strong>Rank:</strong></td><td>3rd out of 45</td></tr>
                    </table>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Question-wise Breakdown</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Max Marks</th>
                                    <th>Your Score</th>
                                    <th>Percentage</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Question 1 - Algebra</td>
                                    <td>20</td>
                                    <td>18</td>
                                    <td>90%</td>
                                    <td><span class="badge bg-success">Excellent</span></td>
                                </tr>
                                <tr>
                                    <td>Question 2 - Geometry</td>
                                    <td>20</td>
                                    <td>17</td>
                                    <td>85%</td>
                                    <td><span class="badge bg-success">Excellent</span></td>
                                </tr>
                                <tr>
                                    <td>Question 3 - Calculus</td>
                                    <td>20</td>
                                    <td>16</td>
                                    <td>80%</td>
                                    <td><span class="badge bg-info">Good</span></td>
                                </tr>
                                <tr>
                                    <td>Question 4 - Statistics</td>
                                    <td>20</td>
                                    <td>18</td>
                                    <td>90%</td>
                                    <td><span class="badge bg-success">Excellent</span></td>
                                </tr>
                                <tr>
                                    <td>Question 5 - Trigonometry</td>
                                    <td>20</td>
                                    <td>16</td>
                                    <td>80%</td>
                                    <td><span class="badge bg-info">Good</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Teacher's Comments</h6>
                    <div class="alert alert-info">
                        <p class="mb-2"><strong>Strengths:</strong></p>
                        <ul class="mb-2">
                            <li>Excellent understanding of algebraic concepts</li>
                            <li>Clear and well-organized solutions</li>
                            <li>Good problem-solving approach</li>
                        </ul>
                        <p class="mb-2"><strong>Areas for Improvement:</strong></p>
                        <ul class="mb-2">
                            <li>Need more practice with complex calculus problems</li>
                            <li>Work on time management during exams</li>
                        </ul>
                        <p class="mb-0"><strong>Overall Comment:</strong> Excellent performance! Keep up the good work and focus on the areas mentioned above.</p>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6>Performance Comparison</h6>
                    <canvas id="comparisonChart" height="200"></canvas>
                </div>
                <div class="col-md-6">
                    <h6>Improvement Suggestions</h6>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <i class="fas fa-book text-primary me-2"></i>
                            Review calculus fundamentals
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-clock text-warning me-2"></i>
                            Practice timed problem solving
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-users text-info me-2"></i>
                            Join study group sessions
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-question-circle text-success me-2"></i>
                            Attend office hours for clarification
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#resultDetailsContent').html(detailsHtml);
        
        // Initialize comparison chart
        setTimeout(() => {
            const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
            new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: ['Your Score', 'Class Average', 'Highest Score'],
                    datasets: [{
                        label: 'Scores',
                        data: [85, 72, 95],
                        backgroundColor: ['#007bff', '#6c757d', '#28a745'],
                        borderColor: ['#0056b3', '#495057', '#1e7e34'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }, 100);
        
    }, 1000);
}

function exportResults(format) {
    if (format === 'pdf') {
        // Generate PDF export
        window.open('/api-reports/results/pdf/', '_blank');
    } else if (format === 'excel') {
        // Generate Excel export
        window.open('/api-reports/results/csv/', '_blank');
    }
}

function printResults() {
    const printWindow = window.open('', '_blank');
    const resultsTable = document.getElementById('resultsTable').outerHTML;
    
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Academic Results</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                @media print {
                    .no-print { display: none !important; }
                }
                body { font-size: 12px; }
                .table { font-size: 11px; }
                h1, h2, h3 { color: #333; }
            </style>
        </head>
        <body>
            <div class="container-fluid">
                <div class="text-center mb-4">
                    <h2>Academic Results Report</h2>
                    <p>Student: {{ user.get_full_name }}</p>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-3 text-center">
                        <h4>${$('#currentGPA').text()}</h4>
                        <p>Current GPA</p>
                    </div>
                    <div class="col-3 text-center">
                        <h4>${$('#highestGrade').text()}</h4>
                        <p>Highest Grade</p>
                    </div>
                    <div class="col-3 text-center">
                        <h4>${$('#averageScore').text()}</h4>
                        <p>Average Score</p>
                    </div>
                    <div class="col-3 text-center">
                        <h4>${$('#completedSubjects').text()}</h4>
                        <p>Subjects</p>
                    </div>
                </div>
                
                <h4>Detailed Results</h4>
                ${resultsTable}
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 1000);
}

function printResultDetail() {
    const modalContent = document.getElementById('resultDetailsContent').innerHTML;
    const printWindow = window.open('', '_blank');
    
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Result Details</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                @media print {
                    .no-print { display: none !important; }
                }
                body { font-size: 12px; }
                .table { font-size: 11px; }
            </style>
        </head>
        <body>
            <div class="container-fluid">
                <div class="text-center mb-4">
                    <h2>Result Details</h2>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                </div>
                ${modalContent}
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 1000);
}

// Auto-refresh data every 5 minutes
setInterval(loadResultsData, 300000);

// Initialize tooltips
$('[data-bs-toggle="tooltip"]').tooltip();

// Keyboard shortcuts
$(document).keydown(function(e) {
    // Ctrl + P to print
    if (e.ctrlKey && e.which === 80) {
        e.preventDefault();
        printResults();
    }
    
    // Ctrl + E to export
    if (e.ctrlKey && e.which === 69) {
        e.preventDefault();
        exportResults('pdf');
    }
});

// Search functionality
$('#resultsTable_filter input').attr('placeholder', 'Search by subject, grade, or remarks...');

// Custom search function
$.fn.dataTable.ext.search.push(
    function(settings, data, dataIndex) {
        const searchTerm = $('.dataTables_filter input').val().toLowerCase();
        if (!searchTerm) return true;
        
        // Search in all visible columns
        return data.some(cell => 
            cell.toLowerCase().includes(searchTerm)
        );
    }
);

// Performance monitoring
let performanceData = {
    loadTime: Date.now(),
    chartRenderTime: 0,
    dataLoadTime: 0
};

// Track chart render time
const originalChart = Chart;
Chart = function(...args) {
    const start = Date.now();
    const chart = new originalChart(...args);
    performanceData.chartRenderTime += Date.now() - start;
    return chart;
};

// Track data load time
const originalAjax = $.ajax;
$.ajax = function(options) {
    const start = Date.now();
    const originalSuccess = options.success;
    
    options.success = function(data) {
        performanceData.dataLoadTime += Date.now() - start;
        if (originalSuccess) originalSuccess.call(this, data);
    };
    
    return originalAjax.call(this, options);
};

// Log performance metrics
window.addEventListener('load', function() {
    setTimeout(() => {
        console.log('Performance Metrics:', {
            totalLoadTime: Date.now() - performanceData.loadTime,
            chartRenderTime: performanceData.chartRenderTime,
            dataLoadTime: performanceData.dataLoadTime
        });
    }, 2000);
});
</script>
{% endblock %}



